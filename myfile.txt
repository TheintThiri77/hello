This is the final version combining both branches
